---
title: "vignette PlasmodeSim"
output: pdf_document
date: "2022-10-19"
---
Welcome to the vignette about the R package PlasmodeSim. This package is still under development.

```{r,begin , include= F}

# use default LASSO logistic regression

```

## installing plasmodeSim using remotes
To install using `remotes` run:
```{r, install}
#install.packages("remotes")
remotes::install_github("GidiusVanDeKamp/PlasmodeSim")
```


## Setting up
This documents skips some parts, we have skipped the steps to obtain the plpResults and the plpData. 

````{r, setup, message= F}
library(dplyr) 

modelSettings <- PatientLevelPrediction::setLassoLogisticRegression()

plpResultLogistic <- PatientLevelPrediction::loadPlpResult("~/R/internshipErasmusMC/simulate-new-patients-outcomes/plp_demolog/Result")

plpData<- PatientLevelPrediction::loadPlpData("~/R/internshipErasmusMC/simulate-new-patients-outcomes/plp_demolog/Data" )
````

## Example 1

In this example we obtain new outcomes of a fitted logistic model.
````{r, ex1, message=F}
plpModelLog <- plpResultLogistic$model
probabilites <- PlasmodeSim::newPropsParametersPlpModel(plpModelLog, plpData, plpData$cohorts)
```` 
The function predictPlp returned this information. 

````{r}
newOut <- PlasmodeSim::newOutcomes(200, probabilites)
head(newOut)

````
In the output of newOut patients are drawed randomly with the same chance, the patients could be drawed multiple times. If this happens they can have a different outcome. The function `newOutcomes` needs a data set where the column that contains the probabilities is called `value`.

## Example 2 
We here we show how to simulate new outcomes from an unfitted logistic model.

````{R, ex2,message=F } 
Parameters <- plpModelLog$model$coefficients
UnfittedParameters <- Parameters
UnfittedParameters[1,1] <- -0.4
UnfittedParameters[2:4,1] <- 0.4
head(UnfittedParameters)
````
For the logistic model it is necessary that the parameters are stored in a dataset with a column called `betas` and a column called `covariateIds`.  

````{r,message=F}
plpModelunfitted <- PlasmodeSim::makeLogisticModel(UnfittedParameters)
newprobs <- PatientLevelPrediction::predictPlp(plpModelunfitted, plpData,plpData$cohorts)
newOut <- PlasmodeSim::newOutcomes(200, newprobs)
head(newOut)
````

## Visual simulations

The function `visualOutcome` simulated new data and then plots the frequency of the outcome.
Right now the function `visualOutcome` only works for a logistic model. The green line in the plots is the average outcome in the original dataset. 
````{r, visual, message= F, out.width = "60%"}
PlasmodeSim::visualOutcome(plpData,50,200,Parameters)
PlasmodeSim::visualOutcome(plpData,50,200,UnfittedParameters)
````
Here we have plotted 50 times the frequency of the outcome for a simulated dataset with 200 people. 

## Visual of a specific covariate

````{r, visual2, message= F, out.width = "60%"}

covariateIdToStudy<- plpResultLogistic$covariateSummary$covariateId[3]
UnfittedParameters[3,]

PlasmodeSim::visualOutcomeCovariateId(plpData, covariateIdToStudy, 20, 200, UnfittedParameters)
PlasmodeSim::visualOutcomeCovariateId2(plpData, covariateIdToStudy, 20, 200, UnfittedParameters)

````

As one can see `visualOutcomeCovariateId` and `visualOutcomeCovariateId2` are very similiar, they both calculate and plot the frequency for a group with a specific covariate present. The small difference is that `visualOutcomeCovariateId` filters a newly simulated dataset set to only keep the patients where the covariate is present, and `visualOutcomeCovariateId2` only simulates new outcomes for patients that have the covariate present. 
We see they are almost the identical only `visualOutcomeCovariateId2` is spread out less because the groups for calculating the frequency with are bigger.

## Survival times outcomes. 

For simulating new survival times we need more than one probability, we use the baselinehazard, stored in the plpModel.

````{r, cox model setup, results= 'hide', message= F}
plpResult <- PatientLevelPrediction::loadPlpResult("~/R/internshipErasmusMC/simulate-new-patients-outcomes/plp_demoCox/Result")
plpData <- PatientLevelPrediction::loadPlpData("~/R/internshipErasmusMC/simulate-new-patients-outcomes/plp_demoCox/Data")
plpModel<- plpResult$model #a fitted Cox model 

populationSettings <- PatientLevelPrediction::createStudyPopulationSettings(
  binary = TRUE,
  includeAllOutcomes = FALSE,
  firstExposureOnly = FALSE,
  washoutPeriod = 180,
  removeSubjectsWithPriorOutcome = FALSE,
  priorOutcomeLookback = 99999,
  requireTimeAtRisk = TRUE,
  minTimeAtRisk = 1,
  riskWindowStart = 1,
  startAnchor = 'cohort start',
  riskWindowEnd = 7300,
  endAnchor = 'cohort start'
)

newdata <- PlasmodeSim::simulateSurvivaltimes(plpModel, plpData, 3, populationSettings)
head(newdata)
# function that simulates uncensored data,  simulateSurvivaltimes(plpModel, plpData, 20)
````

## Simulation censored survival data

first we have to set some settings. 
````{R,message= F}

executeSettings <- PatientLevelPrediction::createExecuteSettings(
  runSplitData = TRUE,
  runSampleData = FALSE,
  runfeatureEngineering = FALSE,
  runPreprocessData = TRUE,
  runModelDevelopment = TRUE,
  runCovariateSummary = TRUE
)
splitSettings <- PatientLevelPrediction::createDefaultSplitSetting(
  testFraction = 0.25,
  trainFraction = 0.75,
  splitSeed = 123,
  nfold = 3,
  type = 'stratified'
)
sampleSettings <- PatientLevelPrediction::createSampleSettings(
  type = 'none'
)
featureEngineeringSettings <- PatientLevelPrediction::createFeatureEngineeringSettings(
  type = 'none'
)
preprocessSettings <- PatientLevelPrediction::createPreprocessSettings(
  minFraction = 0,
  normalize = TRUE,
  removeRedundancy = TRUE
)
modelSettings <- PatientLevelPrediction::setCoxModel()

````
now that we have out settings. We define a training set and fit the model. The model acctually consist of two plpModels stored in a list. 

````{R,message= F }
TrainingSet <- PlasmodeSim::MakeTraingSet(plpData, executeSettings, populationSettings, splitSettings, sampleSettings, preprocessSettings, featureEngineeringSettings, outcomeId=3)

fitcensor <- PlasmodeSim::fitCensoring(TrainingSet$Train, modelSettings)

NewOutcomes <- PlasmodeSim::simulateSurvivaltimesWithCensoring(fitcensor, plpData, populationSettings, 20)
head(NewOutcomes)

````

# Make an unfitted model

````{R, }
# makeCoxModel. 
coeff <- plpModel$model$coefficients
survival <- plpModel$model$baselineSurvival$surv
times <- plpModel$model$baselineSurvival$time

unfittedmodel <- PlasmodeSim::makeCoxModel(coeff, survival, times)

unfittedmodel$preprocessing <- plpModel$preprocessing
unfittedmodel$covariateImportance <- plpModel$covariateImportance



newdata <- PlasmodeSim::simulateSurvivaltimes(unfittedmodel , plpData, 3, populationSettings)
#head(newdata)

````
