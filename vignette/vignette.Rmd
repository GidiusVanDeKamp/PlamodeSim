---
title: "Vignette PlasmodeSim"
output:
  pdf_document: default
  html_document:
    df_print: paged
date: "2022-10-19"
---
Welcome to the vignette about the R package PlasmodeSim. This package is still under development.
This package goal is to simulate a new outcomes for real patients data where the outcomes follow a specified model.

## installing plasmodeSim using remotes
To install using `remotes` run:
```{r, install}
#install.packages("remotes")
#remotes::install_github("GidiusVanDeKamp/PlasmodeSim")
```

## Setting up
To start we need a plpModel and plpData. For information how to obtain these one can look at: https://ohdsi.github.io/PatientLevelPrediction/articles/BuildingPredictiveModels.html 
In this documents we load them from a save file:

````{r, setup fake, eval= F}
plpResultLogistic <- PatientLevelPrediction::loadPlpResult( "yourpathForPlpResult")
plpData <- PatientLevelPrediction::loadPlpData( "yourPathForPlpData" )

````
````{r, setup, message= F, echo = F}

plpResultLogistic <- PatientLevelPrediction::loadPlpResult(
  "~/R/internshipErasmusMC/simulate-new-patients-outcomes/plp_demolog/Result")

plpData<- PatientLevelPrediction::loadPlpData(
  "~/R/internshipErasmusMC/simulate-new-patients-outcomes/plp_demolog/Data" )
````

## Example 1 Simulate from a plpModel

In this example we obtain new outcomes following a fitted logistic model. We start from a plpModel, then run predictPlp. At last we generate new outcomes with the function `newOutcomes` that uses the plpPrediction.
````{r, ex1, message=F}
plpModelLog <- plpResultLogistic$model

plpPrediction <- PatientLevelPrediction::predictPlp(
  plpModel =plpModelLog,
  plpData= plpData,
  population = plpData$cohorts
)

```` 
When running the function predictPlp it returnes some information. 

````{r}
newOut <- PlasmodeSim::newOutcomes(
  noPersons = 200,
  props=  plpPrediction
)
head(newOut)

````
The rowId in the output of `newOutcomes` are the rowId of patients that are drawn randomly with the same probability, the patients could be drawn multiple times. If a rowId happens to be in the output twice they can have a different outcome. The function `newOutcomes` needs a data set that contains the columns `rowId` and `value`. The column called `value` contains the probabilities used in generating the new outcomes.

## Example 2 simulation from unfittedmodel

We here we show how to simulate outcomes from an unfitted logistic model. We use the function `makeLogisiticModel` to specify a logistic model.  

````{R, ex2,message=F } 
Parameters <- plpModelLog$model$coefficients
UnfittedParameters <- Parameters
UnfittedParameters[1,1] <- -0.4
UnfittedParameters[3:5,1] <- 0.4
head(UnfittedParameters)
````
For the logistic model it is necessary that the parameters are stored in a dataset with a column called `betas` and a column called `covariateIds`. The function `makeLogisitcModel` makes a plpModel from the specified parameters.

````{r,message=F}
plpModelunfitted <- PlasmodeSim::makeLogisticModel(UnfittedParameters)
newprobs <- PatientLevelPrediction::predictPlp(
  plpModel =plpModelunfitted,
  plpData=plpData,
  population= plpData$cohorts
)
newOut <- PlasmodeSim::newOutcomes(2000, newprobs)
head(newOut)

# 
# newOut <- dplyr::distinct(newOut,rowId, .keep_all= TRUE)
# 
# modelSettings <- PatientLevelPrediction::setLassoLogisticRegression()
# splitSettings <- PatientLevelPrediction::createDefaultSplitSetting()
# 
# populationSettings <- PatientLevelPrediction::createStudyPopulationSettings(
#   binary = T,
#   includeAllOutcomes = FALSE,
#   firstExposureOnly = FALSE,
#   washoutPeriod = 180,
#   removeSubjectsWithPriorOutcome = FALSE,
#   priorOutcomeLookback = 99999,
#   requireTimeAtRisk = TRUE,
#   minTimeAtRisk = 364,
#   riskWindowStart = 1,
#   startAnchor = 'cohort start',
#   riskWindowEnd = 365,
#   endAnchor = 'cohort start'
# )
# 
# population <- PatientLevelPrediction::createStudyPopulation(plpData , 3, populationSettings)
# population <- dplyr::filter(population, rowId %in% newOut$rowId)
# population <- dplyr::left_join(population, newOut, by = 'rowId') 
# head(population)
# population <- dplyr::mutate(population, outcomeCount = outcomeCount.y)
# population <- dplyr::select(population,-outcomeCount.y, -outcomeCount.x)
# 
# 
# population$outcomeCount 
# 
#   
# trainData <- PatientLevelPrediction::splitData(plpData= plpData, population = population, splitSettings)
# weirdFit <- PatientLevelPrediction::fitPlp(trainData$Train,
#                                            modelSettings,
#                                            analysisId = 'firstTry')
# 
# weirdFit$model$coefficients

````

## Visual simulations

The function `visualOutcome` simulates new data and then plots the frequency of the outcome.
Right now the function `visualOutcome` only works for a logistic model. The green line in the plots is the average outcome in the original dataset. 
````{r, visual, message= F, out.width = "60%"}
PlasmodeSim::visualOutcome(
  plpData = plpData,
  noSimulations = 50, 
  noPersons = 400,
  parameters = Parameters
)
PlasmodeSim::visualOutcome(
  plpData = plpData,
  noSimulations = 50,
  noPersons = 400,
  parameters = UnfittedParameters
)
````

Here we have plotted 50 times the frequency of the outcome for a simulated dataset with 200 people. We can see that the outcome count for the fitted parameters is similar tot the original dataset, but when changeing the parameters the outcome count also changes. 

## Visual of a specific covariate
Say we are interested in the outcomes of a group with a specific covariate. Here we picked the third covariate in the model to visualise. 

````{r, visual2, message= F, out.width = "60%"}

covariateIdToStudy<- plpResultLogistic$covariateSummary$covariateId[4]
UnfittedParameters[4,]

PlasmodeSim::visualOutcomeCovariateId(
  plpData=plpData, 
  studyCovariateId= covariateIdToStudy, 
  noSimulations = 20,
  noPersons = 200, 
  parameters= UnfittedParameters
)
PlasmodeSim::visualOutcomeCovariateId2(
  plpData=plpData,
  restrictToCovariateId= covariateIdToStudy,
  noSimulations = 20,
  noPersons= 200,
  parameters= UnfittedParameters 
)
PlasmodeSim::visualOutcomeCovariateId2(
  plpData=plpData,
  restrictToCovariateId= covariateIdToStudy,
  noSimulations = 20,
  noPersons= 200,
  parameters= Parameters 
)

````

As one can see `visualOutcomeCovariateId` and `visualOutcomeCovariateId2` are very similiar, they both calculate and plot the frequency for a group with a specific covariate present. The small difference is that `visualOutcomeCovariateId` filters a newly simulated dataset set to only keep the patients where the covariate is present, and `visualOutcomeCovariateId2` only simulates new outcomes for patients that have the covariate present. 
We see they are almost the identical only `visualOutcomeCovariateId2` is spread out less because the groups for calculating the frequency with are larger. 
Again we see that when picking the fitted parameters the outcome count for patients with a specific covariate is similar as it was in the original data set.
